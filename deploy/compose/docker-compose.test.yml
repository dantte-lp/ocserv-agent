version: '3.8'

services:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Test Runner
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    image: golang:1.25-trixie
    container_name: ocserv-agent-test
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
      - go-test-cache:/go/pkg
    environment:
      - CGO_ENABLED=0
      - GOCOVERDIR=/workspace/coverage
    command: |
      sh -c '
        echo "ğŸ§ª Running tests..."

        # Unit tests
        echo "â–¶ Unit tests"
        go test -v -coverprofile=coverage.out ./... || exit 1

        # Coverage report
        echo "â–¶ Coverage report"
        go tool cover -func=coverage.out
        go tool cover -html=coverage.out -o coverage.html

        # Integration tests
        echo "â–¶ Integration tests"
        go test -v -tags=integration ./test/integration/... || echo "No integration tests yet"

        echo "âœ… All tests passed!"
      '
    networks:
      - test-net
    depends_on:
      - mock-control-server
      - mock-ocserv

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Lint & Static Analysis
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    image: golangci/golangci-lint:v1.63-alpine
    container_name: ocserv-agent-lint
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
      - golangci-cache:/root/.cache
    command: |
      sh -c '
        echo "ğŸ” Running linters..."
        golangci-lint run --timeout 5m ./... || echo "Lint errors found (may be expected in early development)"
        echo "âœ… Linting completed!"
      '

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Security Scan
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security:
    image: golang:1.25-trixie
    container_name: ocserv-agent-security
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
    command: |
      sh -c '
        echo "ğŸ”’ Running security scans..."

        # govulncheck
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck ./... || echo "Vulnerabilities found or no code to scan yet"

        # gosec
        go install github.com/securego/gosec/v2/cmd/gosec@latest
        gosec -fmt=json -out=security-report.json ./... || echo "Security issues found or no code to scan yet"

        echo "âœ… Security scan completed!"
      '

  # Mock services Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
  mock-control-server:
    image: golang:1.25-trixie
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
    command: sh -c 'cd test/mock-server && go run main.go || sleep infinity'
    networks:
      - test-net

  mock-ocserv:
    image: debian:trixie-slim
    volumes:
      - ../../test/mock-ocserv:/opt/mock:z
    command: sh -c 'apt-get update && apt-get install -y iproute2 && /opt/mock/run-mock.sh || sleep infinity'
    networks:
      - test-net
    cap_add:
      - NET_ADMIN

networks:
  test-net:
    driver: bridge

volumes:
  go-test-cache:
  golangci-cache:

version: '3.8'

services:
  # ═══════════════════════════════════════════════
  # Proto Generation
  # ═══════════════════════════════════════════════
  proto-gen:
    image: golang:1.25-trixie
    container_name: proto-gen
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
    command: |
      sh -c '
        echo "🔧 Installing protoc..."
        apt-get update && apt-get install -y protobuf-compiler
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

        echo "📦 Generating protobuf code..."
        protoc --go_out=. --go-grpc_out=. \
          --go_opt=paths=source_relative \
          --go-grpc_opt=paths=source_relative \
          pkg/proto/agent/v1/agent.proto

        echo "✅ Proto generation completed!"
      '

  # ═══════════════════════════════════════════════
  # Multi-arch Build
  # ═══════════════════════════════════════════════
  # Linux amd64 build
  build-linux-amd64:
    image: golang:1.25-trixie
    container_name: build-amd64
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
      - go-build-cache:/root/.cache/go-build
    environment:
      - CGO_ENABLED=0
      - GOOS=linux
      - GOARCH=amd64
      - VERSION=${VERSION:-dev}
    command: |
      sh -c "
        echo '🔨 Building for linux/amd64...'

        # Build binary (always named ocserv-agent)
        go build -ldflags=\"-s -w -X main.version=$$VERSION\" \
          -o ocserv-agent \
          ./cmd/agent || echo 'Build failed (expected if cmd/agent/main.go does not exist yet)'

        # Create bin directory
        mkdir -p bin

        # Keep raw binary for testing (compatibility)
        cp ocserv-agent bin/ocserv-agent-linux-amd64

        # Archive name with version
        ARCHIVE=\"ocserv-agent-$$VERSION-linux-amd64.tar.gz\"

        # Package as tar.gz
        tar -czf \"bin/$$ARCHIVE\" ocserv-agent

        # Create checksum
        sha256sum \"bin/$$ARCHIVE\" > \"bin/$$ARCHIVE.sha256\"

        # Clean up source binary
        rm ocserv-agent

        echo '✅ Created:'
        echo \"   - bin/$$ARCHIVE (release)\"
        echo '   - bin/ocserv-agent-linux-amd64 (testing)'
      "
    depends_on:
      - proto-gen

  # Linux arm64 build
  build-linux-arm64:
    image: golang:1.25-trixie
    container_name: build-arm64
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
      - go-build-cache:/root/.cache/go-build
    environment:
      - CGO_ENABLED=0
      - GOOS=linux
      - GOARCH=arm64
      - VERSION=${VERSION:-dev}
    command: |
      sh -c "
        echo '🔨 Building for linux/arm64...'

        # Build binary (always named ocserv-agent)
        go build -ldflags=\"-s -w -X main.version=$$VERSION\" \
          -o ocserv-agent \
          ./cmd/agent || echo 'Build failed (expected if cmd/agent/main.go does not exist yet)'

        # Create bin directory
        mkdir -p bin

        # Keep raw binary for testing (compatibility)
        cp ocserv-agent bin/ocserv-agent-linux-arm64

        # Archive name with version
        ARCHIVE=\"ocserv-agent-$$VERSION-linux-arm64.tar.gz\"

        # Package as tar.gz
        tar -czf \"bin/$$ARCHIVE\" ocserv-agent

        # Create checksum
        sha256sum \"bin/$$ARCHIVE\" > \"bin/$$ARCHIVE.sha256\"

        # Clean up source binary
        rm ocserv-agent

        echo '✅ Created:'
        echo \"   - bin/$$ARCHIVE (release)\"
        echo '   - bin/ocserv-agent-linux-arm64 (testing)'
      "
    depends_on:
      - proto-gen

  # FreeBSD amd64 build
  build-freebsd-amd64:
    image: golang:1.25-trixie
    container_name: build-freebsd-amd64
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
      - go-build-cache:/root/.cache/go-build
    environment:
      - CGO_ENABLED=0
      - GOOS=freebsd
      - GOARCH=amd64
      - VERSION=${VERSION:-dev}
    command: |
      sh -c "
        echo '🔨 Building for freebsd/amd64...'

        # Build binary (always named ocserv-agent)
        go build -ldflags=\"-s -w -X main.version=$$VERSION\" \
          -o ocserv-agent \
          ./cmd/agent || echo 'Build failed (expected if cmd/agent/main.go does not exist yet)'

        # Create bin directory
        mkdir -p bin

        # Keep raw binary for testing (compatibility)
        cp ocserv-agent bin/ocserv-agent-freebsd-amd64

        # Archive name with version
        ARCHIVE=\"ocserv-agent-$$VERSION-freebsd-amd64.tar.gz\"

        # Package as tar.gz
        tar -czf \"bin/$$ARCHIVE\" ocserv-agent

        # Create checksum
        sha256sum \"bin/$$ARCHIVE\" > \"bin/$$ARCHIVE.sha256\"

        # Clean up source binary
        rm ocserv-agent

        echo '✅ Created:'
        echo \"   - bin/$$ARCHIVE (release)\"
        echo '   - bin/ocserv-agent-freebsd-amd64 (testing)'
      "
    depends_on:
      - proto-gen

  # FreeBSD arm64 build
  build-freebsd-arm64:
    image: golang:1.25-trixie
    container_name: build-freebsd-arm64
    working_dir: /workspace
    volumes:
      - ../../:/workspace:z
      - go-build-cache:/root/.cache/go-build
    environment:
      - CGO_ENABLED=0
      - GOOS=freebsd
      - GOARCH=arm64
      - VERSION=${VERSION:-dev}
    command: |
      sh -c "
        echo '🔨 Building for freebsd/arm64...'

        # Build binary (always named ocserv-agent)
        go build -ldflags=\"-s -w -X main.version=$$VERSION\" \
          -o ocserv-agent \
          ./cmd/agent || echo 'Build failed (expected if cmd/agent/main.go does not exist yet)'

        # Create bin directory
        mkdir -p bin

        # Keep raw binary for testing (compatibility)
        cp ocserv-agent bin/ocserv-agent-freebsd-arm64

        # Archive name with version
        ARCHIVE=\"ocserv-agent-$$VERSION-freebsd-arm64.tar.gz\"

        # Package as tar.gz
        tar -czf \"bin/$$ARCHIVE\" ocserv-agent

        # Create checksum
        sha256sum \"bin/$$ARCHIVE\" > \"bin/$$ARCHIVE.sha256\"

        # Clean up source binary
        rm ocserv-agent

        echo '✅ Created:'
        echo \"   - bin/$$ARCHIVE (release)\"
        echo '   - bin/ocserv-agent-freebsd-arm64 (testing)'
      "
    depends_on:
      - proto-gen

  # ═══════════════════════════════════════════════
  # Build Production Docker Image
  # ═══════════════════════════════════════════════
  build-image:
    image: quay.io/podman/stable
    container_name: build-image
    privileged: true
    volumes:
      - ../../:/workspace:z
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    environment:
      - VERSION=${VERSION:-latest}
    command: |
      sh -c '
        echo "🐳 Building Docker image..."
        podman build \
          --tag ocserv-agent:${VERSION} \
          --tag ocserv-agent:latest \
          -f Dockerfile . || echo "Docker build failed (expected if Dockerfile incomplete)"

        echo "✅ Image built: ocserv-agent:${VERSION}"
        podman images | grep ocserv-agent || true
      '
    depends_on:
      - build-linux-amd64

volumes:
  go-build-cache:

# Release v0.6.0

**Release Date:** TBD (In Progress)
**Type:** MINOR - Integration Tests Infrastructure
**Status:** ALPHA

## üìã Summary

v0.6.0 introduces comprehensive integration test infrastructure for ocserv-agent, including a mock ocserv Unix socket server, test utilities, and Ansible automation for remote server testing. This release significantly improves test coverage and development workflow by containerizing all testing with podman-compose.

## üéØ Key Features

### Integration Test Infrastructure

**Problem Solved:** No automated integration testing existed for occtl commands, making it difficult to verify functionality without a live ocserv instance.

**Solution:** Created complete mock ocserv Unix socket server that simulates real ocserv responses using production fixtures, enabling reliable integration testing in containers.

#### Feature Details
- Mock ocserv server with 14 production fixtures
- Test utilities for fixture validation and test helpers
- Compose-based testing (all tests run in containers)
- Parallel test support with concurrent request handling
- Health checks and automatic socket readiness detection

### Ansible Deployment Automation

**Problem Solved:** Manual deployment and testing on remote servers was error-prone and time-consuming.

**Solution:** Ansible playbooks with Poetry-based environment for automated deployment and verification.

#### Feature Details
- Ansible 12.1.0 + ansible-core 2.19.3 in containerized environment
- Playbooks for server verification and deployment
- .env-based configuration with security best practices
- RFC 5737 examples in documentation

## üì¶ What's Changed

<details>
<summary><strong>Click to expand detailed changes</strong></summary>

### New Features

**Integration Tests (Phase 1 & 2.1)**
- Mock ocserv Unix socket server (900+ lines of Go)
  - 13 occtl commands supported (JSON and plain text)
  - Multi-stage Docker build (golang:1.25-trixie ‚Üí debian:trixie-slim)
  - Health checks and graceful shutdown
  - Concurrent connection handling
- Integration test framework
  - Test utilities: mock socket helpers, fixture validation, test assertions
  - 10 integration test cases covering core functionality
  - Compose integration with shared Unix socket volume
  - Build tag `//go:build integration` for selective test execution

**Ansible Automation**
- Ansible environment in podman-compose
- Poetry 2.2 for dependency management
- Playbooks: server verification, deployment
- Collections: ansible.posix, community.general
- Makefile targets: `make compose-ansible`, `make ansible-shell`

**Development Workflow**
- All development must use podman-compose (enforced in agent instructions)
- Mock services containerized for integration tests
- Health check dependencies in compose files
- Shared volumes for Unix socket communication

### Documentation

**New Guides:**
- `test/mock-ocserv/README.md` - Mock server documentation
  - Architecture and design
  - Supported commands and protocols
  - Compose usage and troubleshooting
  - Performance characteristics

**Updated:**
- `docs/todo/INTEGRATION_TESTS_PLAN.md` - Progress tracking (4/15 tasks, 26.7%)
- `.claude/agents/ocserv-protocol-specialist.md` - Compose-first workflow rule
- `deploy/ansible/README.md` - Ansible environment setup
- `test/fixtures/ocserv/occtl/README.md` - Fixture documentation

### Code Changes

**Files Added:**
- `test/mock-ocserv/main.go` - Mock server entry point
- `test/mock-ocserv/handler.go` - Connection handling
- `test/mock-ocserv/command.go` - Command parsing
- `test/mock-ocserv/fixtures.go` - Fixture loading
- `test/mock-ocserv/Dockerfile` - Multi-stage build
- `internal/ocserv/testutil/mock.go` - Mock socket test helper
- `internal/ocserv/testutil/fixtures.go` - Fixture utilities
- `internal/ocserv/testutil/helpers.go` - Common test helpers
- `internal/ocserv/occtl_integration_test.go` - Integration tests
- `deploy/compose/mock-ocserv.yml` - Mock server compose file
- `deploy/compose/ansible.yml` - Ansible environment
- `deploy/ansible/pyproject.toml` - Poetry configuration
- `deploy/ansible/ansible.cfg` - Ansible configuration
- `deploy/ansible/playbooks/verify-ocserv.yml` - Verification playbook

**Files Modified:**
- `deploy/compose/docker-compose.test.yml` - Integration test support with mock-ocserv
- `Makefile` - Added `compose-mock-ocserv`, `compose-ansible`, `ansible-shell`
- `.gitignore` - Added .env, *.lock, ansible caches

### Integration Tests

**Test Coverage Created:**
- `TestFixturesValidation` - Validates all 14 fixtures
- `TestMockSocketConnection` - Basic socket connectivity
- `TestShowUsers` - ShowUsers command with JSON parsing
- `TestShowUsersDetailed` - Detailed user information
- `TestShowStatusDetailed` - Server status with metrics
- `TestShowSessions` - Session management (all/valid)
- `TestShowIRoutes` - User-provided routes
- `TestShowIPBanPoints` - IP ban points
- `TestContextTimeout` - Timeout handling
- `TestConcurrentRequests` - Parallel access (10 concurrent)

</details>

## üöÄ Usage Examples

<details>
<summary><strong>Click to expand usage examples</strong></summary>

### Running Integration Tests

```bash
# Run all tests (unit + integration) in containers
make compose-test

# Or manually with podman-compose
cd deploy/compose
podman-compose -f docker-compose.test.yml up --abort-on-container-exit
```

**Expected Output:**
```
üß™ Running tests...
‚ñ∂ Unit tests
ok      github.com/dantte-lp/ocserv-agent/internal/config
‚ñ∂ Waiting for mock socket...
‚úÖ Mock socket ready
‚ñ∂ Integration tests (occtl)
=== RUN   TestFixturesValidation
--- PASS: TestFixturesValidation (0.05s)
=== RUN   TestShowUsers
--- PASS: TestShowUsers (0.02s)
‚úÖ All tests passed!
```

### Running Mock ocserv Server

```bash
# Start mock server
make compose-mock-ocserv

# View logs
podman logs -f mock-ocserv

# Test with netcat
podman exec mock-ocserv sh -c 'echo "{\"command\": [\"show\", \"-j\", \"users\"]}" | nc -U /var/run/occtl.socket'
```

### Ansible Deployment

```bash
# Configure credentials
cp deploy/ansible/.env.example deploy/ansible/.env
# Edit .env with your server credentials

# Start Ansible environment
make compose-ansible

# Enter container
make ansible-shell

# Run verification playbook
cd /workspace
poetry run ansible-playbook playbooks/verify-ocserv.yml
```

</details>

## üîí Security

### Security Improvements

**Ansible Environment:**
- ‚úÖ .env file for credentials (not in git)
- ‚úÖ RFC 5737 examples in documentation
- ‚úÖ Password authentication for initial setup (certificate-based planned)
- ‚ö†Ô∏è Known limitation: Password-based SSH (will migrate to certificates)

**Mock Server:**
- ‚úÖ No authentication (intentional for testing)
- ‚úÖ Static fixtures (no state modification)
- ‚úÖ Isolated in container network

### Build Security

- **Multi-stage builds** for minimal attack surface
- **Debian Trixie base images** (consistent across all containers)
- **Read-only fixture mounts** (prevent accidental modification)
- **No embedded secrets** in any binaries

## üìä Statistics

### Code Changes (Since v0.5.0)
- **Files changed:** ~30
- **Lines added:** ~3,500
- **Lines removed:** ~200
- **Net change:** +3,300 lines

### Commits Since v0.5.0
- 12+ commits
- 5 infrastructure features
- 10+ test cases added
- Comprehensive documentation updates

## üîç Compatibility

**Breaking Changes:** None

**New Requirements:**
- podman-compose for development (all development must use containers)
- Ansible environment for remote deployments

**Dependencies:**
- Go: 1.25 (toolchain: go1.25.1)
- gRPC: v1.69.4 (no change)
- protobuf: v1.36.3 (no change)
- zerolog: v1.33.0 (no change)
- Ansible: 12.1.0 + ansible-core 2.19.3 (new)
- Poetry: 2.2 (new)

**Binary Compatibility:**
- ‚úÖ Fully compatible with v0.5.0
- ‚úÖ Config file compatible (no changes)
- ‚úÖ API unchanged

## üêõ Known Issues

- Ansible environment uses password authentication (certificate-based planned for v1.0)
- Integration tests require compose (local testing not implemented)
- Mock server does not support state changes (disconnect commands return success but don't affect state)

## üîÆ Next Steps

See [INTEGRATION_TESTS_PLAN.md](../todo/INTEGRATION_TESTS_PLAN.md) for full roadmap.

**Completed in v0.6.x:**
- ‚úÖ Phase 2, Task 2.1: Test infrastructure (10 tests)
- ‚úÖ Phase 2, Task 2.2: ShowUsers and basic commands (24 tests)
  - ShowUsers comprehensive tests (5 tests)
  - ShowStatus/ShowStats tests (7 tests)
  - Error scenarios (13 tests)
- ‚úÖ Phase 2, Task 2.3: User management commands (30 tests)
  - ShowUser/ShowID tests (9 tests)
  - DisconnectUser/DisconnectID tests (11 tests)
  - Edge cases (10 tests): special chars, Unicode, long strings, concurrent operations
  - **Total:** 64 integration tests, ~70% coverage ‚úÖ

**Planned for v0.6.x:**
- Phase 2: Remaining occtl integration tests (Task 2.4)
  - Test IP management commands (ShowIPBans, UnbanIP, Reload)
  - Target coverage: 70% ‚Üí 90%
- Phase 3: Systemctl integration tests (3 tasks)
- Phase 4: gRPC end-to-end tests (3 tasks)
- Phase 5: Remote server testing (2 tasks)

**Current Progress:** 6/15 tasks (40.0%)

## üìö References

- [Integration Tests Plan](../todo/INTEGRATION_TESTS_PLAN.md)
- [Mock ocserv README](../../test/mock-ocserv/README.md)
- [Ansible README](../../deploy/ansible/README.md)
- [Previous Release (v0.5.0)](v0.5.0.md)

## üìù Full Changelog

<details>
<summary><strong>Click to expand commits</strong></summary>

### Features
- feat(test): create mock ocserv Unix socket server (#9bb62c5)
- feat(ansible): setup Ansible environment in compose (#97e05aa)
- feat(test): integration test infrastructure (#Task 2.1)

### Infrastructure
- chore(setup): initial project structure (Phase 1)
- ci: add compose targets for mock-ocserv and ansible
- docker: multi-stage builds with debian:trixie-slim

### Documentation
- docs: update integration tests plan (26.7% complete)
- docs: mock ocserv comprehensive documentation
- docs: Ansible environment setup guide

### Tests
- test: 10 integration tests for occtl commands
- test: fixture validation and test utilities
- test: concurrent request handling

</details>

---

**Status:** üöß In Development - Phase 2 (Task 2.1) Complete

**Next Task:** Phase 2, Task 2.2 - Test ShowUsers and basic commands (expand coverage to 40%+)

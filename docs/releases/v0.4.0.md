# Release Notes - v0.4.0

**Release Date:** TBD (In Development)
**Type:** MINOR - Unit Tests + Test Infrastructure
**Status:** IN DEVELOPMENT

## ðŸ“‹ Summary

This release focuses on establishing comprehensive test coverage for the project, starting with the critical `internal/config` package. The goal is to achieve >80% overall test coverage to improve code quality, reliability, and maintainability.

## ðŸŽ¯ Key Changes

### âœ… Unit Tests for internal/config Package

**Achievement:** 97.1% test coverage (exceeds >80% target)

**Test Files Created:**
1. `internal/config/config_test.go` (347 lines)
   - `TestLoad` - Config loading from YAML files
   - `TestLoadWithEnvOverrides` - Environment variable overrides
   - `TestSetDefaults` - Default value application
   - `TestBootstrapCertificates` - Certificate auto-generation
   - `TestApplyEnvOverrides` - Environment variable processing

2. `internal/config/validation_test.go` (579 lines)
   - `TestValidate` - Main validation function
   - `TestValidateTLS` - TLS configuration validation
   - `TestValidateOcserv` - ocserv paths validation
   - `TestValidateHealth` - Health check intervals validation
   - `TestValidateLogging` - Logging configuration validation
   - `TestValidateSecurity` - Security settings validation
   - `TestValidateReconnect` - Reconnection policy validation

**Test Fixtures:**
- `test/fixtures/config/valid.yaml` - Complete valid configuration
- `test/fixtures/config/minimal.yaml` - Minimal valid configuration
- `test/fixtures/config/invalid_missing_agent_id.yaml` - Missing agent ID test case
- `test/fixtures/config/invalid_missing_control_server.yaml` - Missing control server test case

**Coverage Details:**
```bash
$ go test -cover ./internal/config/...
ok      github.com/dantte-lp/ocserv-agent/internal/config    97.1% coverage
```

**Test Scenarios Covered:**
- âœ… Valid configuration loading
- âœ… Minimal configuration with defaults
- âœ… Environment variable overrides
- âœ… TLS certificate auto-generation (bootstrap mode)
- âœ… Validation error handling
- âœ… Missing required fields
- âœ… Invalid values (negative intervals, empty strings)
- âœ… Path validation
- âœ… Security settings validation
- âœ… Health check intervals validation

### ðŸ”§ Test Infrastructure Improvements

**Fixed Test Environment:**
1. **CGO + Race Detector Conflict**
   - Issue: `CGO_ENABLED=0` incompatible with `-race` flag
   - Solution: Removed `-race` flag from test configuration
   - File: `deploy/compose/docker-compose.test.yml`

2. **golangci-lint Version Update**
   - Updated: v1.62 â†’ v1.63
   - Reason: Go 1.25 support
   - Impact: Enabled linting for latest Go features

**Test Environment Verified:**
- âœ… `podman-compose` test infrastructure working
- âœ… All tests pass in containerized environment
- âœ… Test coverage measurement enabled
- âœ… CI/CD integration confirmed

## ðŸ“¦ What's Changed

### Features
- Added comprehensive unit tests for `internal/config` package (97.1% coverage)
- Created reusable test fixture infrastructure
- Established test coverage baseline

### Bug Fixes
- Fixed test configuration: removed `-race` flag for static builds
- Updated golangci-lint to v1.63 for Go 1.25 compatibility

### Infrastructure
- Confirmed test environment setup (Podman Compose)
- Established test coverage measurement workflow

## ðŸ“Š Statistics

### Code Changes
- **Files changed:** 7
- **Lines added:** +1,006
- **Lines removed:** -2
- **Net change:** +1,004 lines

### Test Coverage
- **internal/config:** 97.1% âœ…
- **Overall project:** Moving from 0% â†’ targeting >80%
- **Test files:** 2 (926 lines of test code)
- **Test fixtures:** 4 YAML files

### Commits Since v0.3.1
- 1 commit (83e3f05)
- Focus: Test infrastructure and unit tests

## ðŸ”’ Security

### Test Coverage Impact
- âœ… Config validation logic thoroughly tested
- âœ… TLS settings validation verified
- âœ… Security settings validation covered
- âœ… Input validation edge cases tested

### OSSF Scorecard
- **Current:** 5.9/10 (same as v0.3.1)
- **Target for v0.4.0:** 7.5+/10
- **Planned improvements:** Branch protection, token permissions, GPG signing, dependency pinning

## ðŸ”§ Compatibility

**Breaking Changes:** None

**Requirements:**
- Go 1.25+ for development
- ocserv 1.3.0+ (tested)
- gRPC v1.69.4+

**Binary Compatibility:**
- âœ… Fully compatible with v0.3.1
- âœ… No config changes required
- âœ… No API changes

## ðŸ› Known Issues

None reported for v0.4.0 development version.

## ðŸ“ Full Changelog (In Progress)

### Features
- Add comprehensive unit tests for internal/config (97.1% coverage) (83e3f05)

### Bug Fixes
- Fix test infrastructure: remove -race flag for static builds (83e3f05)
- Update golangci-lint to v1.63 for Go 1.25 support (83e3f05)

### Infrastructure
- Create test fixture infrastructure (83e3f05)

## ðŸ”® Next Steps

**Remaining for v0.4.0:**
- [ ] Unit tests for `internal/cert` package
- [ ] Unit tests for `internal/grpc` package
- [ ] Unit tests for `internal/ocserv` package
- [ ] Achieve >80% overall test coverage
- [ ] OSSF Scorecard Phase 1 improvements (branch protection, token permissions)

**Planned for v0.5.0+:**
- [ ] StreamLogs RPC implementation
- [ ] ocpasswd wrapper for user management
- [ ] UpdateConfig RPC with backup/rollback
- [ ] ShowEvents() streaming support (ServerStream RPC)

## ðŸ“š References

- [TODO Management](https://github.com/dantte-lp/ocserv-agent/blob/main/docs/todo/CURRENT.md)
- [Local Testing Guide](https://github.com/dantte-lp/ocserv-agent/blob/main/docs/LOCAL_TESTING.md)
- [Contributing Guide](https://github.com/dantte-lp/ocserv-agent/blob/main/.github/CONTRIBUTING.md)
- [Previous Release (v0.3.1)](https://github.com/dantte-lp/ocserv-agent/blob/main/docs/releases/v0.3.1.md)

---

**Status:** IN DEVELOPMENT - Not yet released

**Target Release Date:** TBD

**Pull Request:** [#14](https://github.com/dantte-lp/ocserv-agent/pull/14) - Unit tests for internal/config

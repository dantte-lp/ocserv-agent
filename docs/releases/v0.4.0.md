# Release Notes - v0.4.0

**Release Date:** TBD (In Development)
**Type:** MINOR - Unit Tests + Test Infrastructure
**Status:** IN DEVELOPMENT

## 📋 Summary

This release focuses on establishing comprehensive test coverage for the project, starting with the critical `internal/config` package. The goal is to achieve >80% overall test coverage to improve code quality, reliability, and maintainability.

## 🎯 Key Changes

### ✅ Unit Tests for internal/config Package

**Achievement:** 97.1% test coverage (exceeds >80% target)

**Problem Solved:** Zero test coverage was identified as a critical gap preventing confident refactoring and future development.

**Solution:** Implemented comprehensive unit tests covering all configuration loading, validation, and environment variable override scenarios.

**Test Files Created:**
1. `internal/config/config_test.go` (347 lines)
   - `TestLoad` - Config loading from YAML files
   - `TestLoadWithEnvOverrides` - Environment variable overrides
   - `TestSetDefaults` - Default value application
   - `TestBootstrapCertificates` - Certificate auto-generation
   - `TestApplyEnvOverrides` - Environment variable processing

2. `internal/config/validation_test.go` (579 lines)
   - `TestValidate` - Main validation function
   - `TestValidateTLS` - TLS configuration validation
   - `TestValidateOcserv` - ocserv paths validation
   - `TestValidateHealth` - Health check intervals validation
   - `TestValidateLogging` - Logging configuration validation
   - `TestValidateSecurity` - Security settings validation
   - `TestValidateReconnect` - Reconnection policy validation

**Test Fixtures:**
- `test/fixtures/config/valid.yaml` - Complete valid configuration
- `test/fixtures/config/minimal.yaml` - Minimal valid configuration
- `test/fixtures/config/invalid_missing_agent_id.yaml` - Missing agent ID test case
- `test/fixtures/config/invalid_missing_control_server.yaml` - Missing control server test case

**Coverage Details:**
```bash
$ go test -cover ./internal/config/...
ok      github.com/dantte-lp/ocserv-agent/internal/config    97.1% coverage
```

**Test Scenarios Covered:**
- ✅ Valid configuration loading
- ✅ Minimal configuration with defaults
- ✅ Environment variable overrides
- ✅ TLS certificate auto-generation (bootstrap mode)
- ✅ Validation error handling
- ✅ Missing required fields
- ✅ Invalid values (negative intervals, empty strings)
- ✅ Path validation
- ✅ Security settings validation
- ✅ Health check intervals validation

### ✅ Unit Tests for internal/cert Package

**Achievement:** 77.6% test coverage (close to 80% target)

**Problem Solved:** Certificate generation code lacked tests, making it risky to modify or debug certificate-related issues.

**Solution:** Created comprehensive tests for all certificate generation functions, PEM operations, and fingerprint calculations.

**Test Files Created:**
- `internal/cert/generator_test.go` (678 lines, 14 test functions)
  - `TestGenerateSelfSignedCerts` - Complete certificate generation workflow
  - `TestGenerateCA` - CA certificate generation and properties
  - `TestGenerateAgentCert` - Agent certificate generation and validation
  - `TestSaveCertificate` / `TestSavePrivateKey` - PEM file operations
  - `TestCalculateFingerprint` - SHA256 fingerprint calculation
  - `TestCertsExist` - Certificate existence checking
  - Helper functions for loading and verification

**Coverage Details:**
```bash
$ go test -cover ./internal/cert/
ok      github.com/dantte-lp/ocserv-agent/internal/cert    77.6% coverage
```

**Functions Coverage:**
- calculateFingerprint: 100%
- CertsExist: 100%
- GenerateSelfSignedCerts: 71.4%
- generateCA: 75.0%
- generateAgentCert: 75.0%
- saveCertificate: 75.0%
- savePrivateKey: 71.4%

### ✅ Unit Tests for internal/ocserv/config.go

**Achievement:** 82-100% test coverage for all functions

**Problem Solved:** ocserv configuration parser lacked tests, making it difficult to verify correct parsing of various config file formats.

**Solution:** Implemented comprehensive tests covering all parsing scenarios including equals format, space-separated format, comments, and multi-value settings.

**Test Files Created:**
- `internal/ocserv/config_test.go` (621 lines, 20 test functions)
  - Configuration file parsing (equals format, space-separated, inline comments)
  - Per-user and per-group configuration files
  - Configuration file listing and discovery
  - Configuration methods (GetSetting, GetSettings, HasSetting, AllKeys)
  - Context cancellation and timeout handling
  - Error scenarios (permission denied, invalid paths, malformed lines)

**Test Fixtures Created:**
- `test/fixtures/ocserv/configs/ocserv.conf` - Full ocserv configuration example
- `test/fixtures/ocserv/configs/minimal.conf` - Minimal valid configuration
- `test/fixtures/ocserv/configs/user-john` - Per-user configuration
- `test/fixtures/ocserv/configs/group-admins` - Per-group configuration

**Coverage Details:**
```bash
$ go test -cover ./internal/ocserv/
ok      github.com/dantte-lp/ocserv-agent/internal/ocserv    15.8% coverage

# But config.go specifically:
NewConfigReader: 100.0%
ReadOcservConf: 100.0%
ReadUserConfig: 100.0%
ReadGroupConfig: 100.0%
ListUserConfigs: 100.0%
ListGroupConfigs: 100.0%
readConfigFile: 82.1%
parseLine: 87.5%
listConfigFiles: 83.3%
GetSetting/GetSettings/HasSetting/AllKeys: 100.0%
```

### 🔧 Test Infrastructure Improvements

**Fixed Test Environment:**
1. **CGO + Race Detector Conflict**
   - Issue: `CGO_ENABLED=0` incompatible with `-race` flag
   - Solution: Removed `-race` flag from test configuration
   - File: `deploy/compose/docker-compose.test.yml`

2. **golangci-lint Version Update**
   - Updated: v1.62 → v1.63
   - Reason: Go 1.25 support
   - Impact: Enabled linting for latest Go features

**Test Environment Verified:**
- ✅ `podman-compose` test infrastructure working
- ✅ All tests pass in containerized environment
- ✅ Test coverage measurement enabled
- ✅ CI/CD integration confirmed

## 📦 What's Changed

<details>
<summary><strong>Click to expand detailed changes</strong></summary>

### New Features

**Test Infrastructure**
- Comprehensive unit tests for `internal/config` package (97.1% coverage)
- Unit tests for `internal/cert` package (77.6% coverage)
- Unit tests for `internal/ocserv/config.go` (82-100% coverage per function)
- Created reusable test fixture infrastructure
- Established test coverage baseline
- Fixed test environment configuration (CGO + race detector conflict)

### Code Changes

**Files Added:**
- `internal/config/config_test.go` (347 lines) - Config loading tests
- `internal/config/validation_test.go` (579 lines) - Validation tests
- `internal/cert/generator_test.go` (678 lines) - Certificate generation tests
- `internal/ocserv/config_test.go` (621 lines) - Config parser tests
- `test/fixtures/config/*.yaml` (4 files) - Config test fixtures
- `test/fixtures/ocserv/configs/*` (4 files) - ocserv config test fixtures

**Files Modified:**
- `deploy/compose/docker-compose.test.yml` - Removed -race flag
- `.golangci.yml` - Updated to v1.63 for Go 1.25 support

### Bug Fixes

**Test Infrastructure:**
- Fixed test configuration: removed `-race` flag for static builds (incompatible with CGO_ENABLED=0)
- Updated golangci-lint to v1.63 for Go 1.25 compatibility

</details>

## 📊 Statistics

### Code Changes
- **Files changed:** 15
- **Lines added:** ~2,470
- **Lines removed:** ~5
- **Net change:** +2,465 lines (mostly tests)

### Test Coverage
- **internal/config:** 97.1% ✅ (exceeds target)
- **internal/cert:** 77.6% ✅ (close to target)
- **internal/ocserv/config.go:** 82-100% ✅ (per function)
- **Overall internal/ocserv:** 15.8% (other files pending)
- **Overall project:** Moving from 0% → targeting >80%
- **Test files:** 4 files (2,225 lines of test code)
- **Test fixtures:** 8 files (4 config YAML + 4 ocserv configs)

### Commits Since v0.3.1
- 3 test implementation commits:
  - 83e3f05: internal/config tests (97.1% coverage)
  - a6dee4c: internal/cert tests (77.6% coverage)
  - 36b4678: internal/ocserv/config.go tests (82-100% coverage)

## 🔒 Security

### Test Coverage Impact
- ✅ Config validation logic thoroughly tested
- ✅ TLS settings validation verified
- ✅ Security settings validation covered
- ✅ Input validation edge cases tested

### OSSF Scorecard
- **Current:** 5.9/10 (same as v0.3.1)
- **Target for v0.4.0:** 7.5+/10
- **Planned improvements:** Branch protection, token permissions, GPG signing, dependency pinning

## 🔧 Compatibility

**Breaking Changes:** None

**Requirements:**
- Go 1.25+ for development
- ocserv 1.3.0+ (tested)
- gRPC v1.69.4+

**Binary Compatibility:**
- ✅ Fully compatible with v0.3.1
- ✅ No config changes required
- ✅ No API changes

## 🐛 Known Issues

None reported for v0.4.0 development version.

## 📝 Full Changelog (In Progress)

### Features
- Add comprehensive unit tests for internal/config (97.1% coverage) (83e3f05)

### Bug Fixes
- Fix test infrastructure: remove -race flag for static builds (83e3f05)
- Update golangci-lint to v1.63 for Go 1.25 support (83e3f05)

### Infrastructure
- Create test fixture infrastructure (83e3f05)

## 🔮 Next Steps

**Remaining for v0.4.0:**
- [x] Unit tests for `internal/config` package ✅ (97.1% coverage)
- [x] Unit tests for `internal/cert` package ✅ (77.6% coverage)
- [x] Unit tests for `internal/ocserv/config.go` ✅ (82-100% coverage)
- [ ] Unit tests for `internal/ocserv` remaining files (manager, occtl, systemctl)
- [ ] Unit tests for `internal/grpc` package (server, handlers)
- [ ] Achieve >80% overall test coverage
- [ ] OSSF Scorecard Phase 1 improvements (branch protection, token permissions)

**Planned for v0.5.0+:**
- [ ] StreamLogs RPC implementation
- [ ] ocpasswd wrapper for user management
- [ ] UpdateConfig RPC with backup/rollback
- [ ] ShowEvents() streaming support (ServerStream RPC)
- [ ] Integration tests with mock ocserv
- [ ] End-to-end tests

## 📚 References

- [TODO Management](https://github.com/dantte-lp/ocserv-agent/blob/main/docs/todo/CURRENT.md)
- [Local Testing Guide](https://github.com/dantte-lp/ocserv-agent/blob/main/docs/LOCAL_TESTING.md)
- [Contributing Guide](https://github.com/dantte-lp/ocserv-agent/blob/main/.github/CONTRIBUTING.md)
- [Previous Release (v0.3.1)](https://github.com/dantte-lp/ocserv-agent/blob/main/docs/releases/v0.3.1.md)

---

**Status:** IN DEVELOPMENT - Not yet released

**Target Release Date:** TBD

**Pull Request:** [#14](https://github.com/dantte-lp/ocserv-agent/pull/14) - Unit tests for internal/config
